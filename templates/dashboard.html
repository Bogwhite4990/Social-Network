<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='dashboard.css') }}">
</head>
<body>
<div class="navbar">
    <span>Welcome, <span class="username" onclick="window.location.href='{{ url_for('profile') }}'">{{ username }}</span>! </span>
    <button class="friends-button" onclick="window.location.href='{{ url_for('friends') }}'" title="Friends Page">üë™</button>
    <div class="game-dropdown">
        <button class="game-button" id="game-icon" title="Game Page">üéÆ</button>
        <div class="game-dropdown-content">
            <a href="{{ url_for('trivia_game') }}">Trivia‚ùì</a>
            <a href="endless-runner">RunnerüèÉ</a>
            <a href="">Game 2</a>
        </div>
    </div>
    <button class="shop-button" onclick="window.location.href='{{ url_for('shop') }}'" title="Shop Page">üõí</button>
        <!-- Add the conditional rendering of the "Admin" button -->
    {% if user_id == 1 %}
        <button class="admin-button" onclick="window.location.href='/admin'" title="Admin Page">üõ†Ô∏è</button>
    {% endif %}
    <div class="centered-content">
        <button class="upload-button" onclick="document.getElementById('upload-photo').click()">Upload</button>
    </div>
    <a href="{{ url_for('logout') }}" class="logout-button">Logout</a>
</div>
<div class="dashboard-content">
    <div class="photo-section">
        <center>
            <h1>Welcome to the Dashboard</h1>
            <p>This is a protected area where you can access different features.</p>
            {% for photo in photos %}
            {% if photo.filename %}
            <div class="photo-box uploaded-photo">
                <div class="image-and-comments">
                    <div class="image-container">
                        <!-- Add a custom data attribute to store the username color -->
                        <!-- Add an onclick event to open the modal when the image is clicked -->
                        <img class="uploaded-image" src="{{ url_for('static', filename='uploads/' ~ photo.filename) }}" alt="Uploaded Photo" data-username-color="{{ photo.user.selected_username_color }}" style="border: 1px solid {{ photo.user.selected_border_color if photo.user.selected_border_color else 'gold' }}" onclick="openModal('{{ url_for('static', filename='uploads/' ~ photo.filename) }}')">
                        <!-- Apply the username color to the username text -->
                        <p><span class="user-status" data-last-seen="{{ photo.user.last_seen }}"></span> Uploaded by, <a href="{{ url_for('user_profile', username=photo.user.username) }}" class="user-profile-link username-color" data-user-id="{{ photo.user.id }}" style="color: {{ photo.user.selected_username_color if photo.user.selected_username_color else 'white' }}">{{ photo.user.username }}</a>
                            <!-- Display icons based on uploaded_photo_count -->
                            {% for threshold, emoji in thresholds_and_icons %}
                                {% if photo.user.uploaded_photo_count >= threshold %}
                                    <span title="{% if threshold == 1 %}1 Photo{% else %}{{ threshold }} Photos{% endif %}">{{ emoji }}</span>
                                {% endif %}
                            {% endfor %}
                        </p>
                    </div>
                    <div class="like-section">
                        <button class="like-button" data-photo-id="{{ photo.id }}" data-liked="{{ photo.is_liked_by_current_user }}">
                            {% if photo.is_liked_by_current_user %} ‚ù§Ô∏è {% else %} ‚ù§Ô∏è {% endif %}
                        </button>
                        <span class="like-count">{{ photo.likes|length }}</span>
                    </div>
                </div>
                <!-- Comment section -->
                <div class="comment-section">
                    <!-- Comment input form -->
                    <form class="comment-form" action="{{ url_for('add_comment') }}" method="post">
                        <input type="hidden" name="photo_id" value="{{ photo.id }}">
                        <input type="text" name="comment" placeholder="Add a comment...">
                        <button type="submit">Post</button>
                    <div class="photo">
                        <button class="view-photo-button" onclick="viewPhoto({{ photo.id }})">View Photo</button>
                    </div>
                    </form>
                    <!-- Display comments -->
                    <div class="comments">
                        <!-- Display all comments for each photo -->
                        {% for comment in photo.comments %}
                        <div class="comment">
                            <div class="comment-text" data-comment-color="{{ comment.user.selected_comment_color }}">
                                <p>
                                    <strong>{{ comment.user.username }}:</strong> {{ comment.text }}
                                </p>
                            </div>
                            {% if current_user == comment.user %}
                            <form action="{{ url_for('delete_comment', comment_id=comment.id) }}" method="post">
                                <button type="submit" class="delete-comment-button">x</button>
                            </form>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                </div>
                <br>
                <br>
                {% if current_user == photo.user %}
                <form class="delete-form" action="{{ url_for('delete_photo', photo_id=photo.id) }}" method="POST">
                    <button class="delete-button" type="submit">Delete</button>
                </form>
                {% endif %}
            </div>
            {% endif %}
            {% endfor %}
            {% if not photos %}
            <p>No photos uploaded</p>
            {% endif %}
        </center>
    </div>
</div>
<!-- Add the modal element to your HTML -->
<div id="imageModal" class="modal">
    <span class="close" onclick="closeModal()">&times;</span>
    <img id="modalImage" class="modal-content" src="" alt="Enlarged Photo">
</div>
<input type="file" id="upload-photo" style="display: none;" accept="image/jpeg,image/png" onchange="handleImageUpload(this)">
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    // JavaScript to handle the game dropdown
document.addEventListener("DOMContentLoaded", function() {
    const gameIcon = document.getElementById("game-icon");
    const gameDropdown = document.querySelector(".game-dropdown-content");

    // Toggle the dropdown when clicking on the game icon
    gameIcon.addEventListener("click", function(event) {
        event.stopPropagation(); // Prevent the click event from propagating to document

        // Toggle the visibility of the dropdown content
        if (gameDropdown.style.display === "block") {
            gameDropdown.style.display = "none";
        } else {
            gameDropdown.style.display = "block";
        }
    });

    // Close the dropdown when clicking outside of it
    document.addEventListener("click", function(event) {
        if (gameDropdown.style.display === "block" && !event.target.closest(".game-dropdown")) {
            gameDropdown.style.display = "none";
        }
    });
});


    function convertUtcToLocal(utcTimestamp) {
        const utcDate = new Date(utcTimestamp);
        const localDate = new Date(utcDate.toLocaleString("en-US", { timeZone: "Europe/Bucharest" })); // Replace "Europe/Bucharest" with the correct user's time zone
        return localDate;
    }

    function updateStatus() {
        $('.user-status').each(function() {
            const lastSeenUtcTimestamp = $(this).data('last-seen'); // Get the UTC timestamp from the data attribute
            const lastSeenLocalTime = convertUtcToLocal(lastSeenUtcTimestamp); // Convert to local time

            // Add 3 hours to the lastSeenLocalTime
            lastSeenLocalTime.setHours(lastSeenLocalTime.getHours() + 3);

            const currentTime = new Date();
            const fiveMinutesAgo = new Date(currentTime - 5 * 60 * 1000); // 5 minutes ago

            if (lastSeenLocalTime >= fiveMinutesAgo) {
                $(this).addClass('online').removeClass('offline').text(' ‚Ä¢ Online'); // Add Online status
            } else {
                $(this).addClass('offline').removeClass('online').text(' ‚Ä¢ Offline'); // Add Offline status
            }
        });
    }

    $(document).ready(function() {
        updateStatus();

        // Update user status every minute (you can adjust the interval as needed)
        setInterval(updateStatus, 60000); // 1 minute
    });


        function viewPhoto(photoId) {
        // Construct the URL for the view_photo page with the photoId
        var url = "/photo/" + photoId; // Update the URL pattern as needed

        // Redirect the user to the view_photo page
        window.location.href = url;
    }
    // JavaScript to handle comment submission
    document.querySelectorAll(".comment-form").forEach(form => {
        form.addEventListener("submit", async (event) => {
            event.preventDefault();
            const formData = new FormData(form);
            const response = await fetch("/add_comment", {
                method: "POST",
                body: formData,
            });
            if (response.ok) {
                // Reload the page or update the comments display as needed
                window.location.reload();
            }
        });
    });

    // JavaScript to handle comment deletion
    document.querySelectorAll(".delete-comment-button").forEach(button => {
        button.addEventListener("click", async () => {
            const response = await fetch(button.parentElement.action, {
                method: "POST",
            });
            if (response.ok) {
                // Reload the page or update the comments display as needed
                window.location.reload();
            }
        });
    });

    // JavaScript to handle like button clicks
    const likeButtons = document.querySelectorAll('.like-button');
    likeButtons.forEach(button => {
        button.addEventListener('click', async () => {
            const photoId = button.getAttribute('data-photo-id');
            const liked = button.getAttribute('data-liked') === 'true';
            const likeCount = button.nextElementSibling; // Item displaying the number of likes
            // Send an AJAX request to the server to update the like
            const response = await fetch(`/like_photo/${photoId}`, {
                method: 'POST',
            });
            if (response.ok) {
                const data = await response.json();
                // Update the number of likes with the value received from the server
                likeCount.textContent = data.like_count;
                // Change the button emoji according to the current state (liked)
                button.textContent = liked ? '‚ù§Ô∏è' : '‚ù§Ô∏è';
                button.setAttribute('data-liked', !liked);
            }
        });
    });

    // Function to handle image uploads (if needed)
    function handleImageUpload(input) {
        if (input.files && input.files[0]) {
            var formData = new FormData();
            formData.append('photo', input.files[0]);
            fetch("{{ url_for('upload_photo') }}", {
                method: 'POST',
                body: formData
            });
        }
        setTimeout(function () {
            window.location.reload();
        }, 1000);
    }

    // Function to apply the border color from the data attribute
    function applyBorderColor() {
        const uploadedImages = document.querySelectorAll('.uploaded-image');
        uploadedImages.forEach(image => {
            const borderColor = image.getAttribute('data-border-color');
            if (borderColor) {
                image.style.borderColor = borderColor; // Set the border color
            }
        });
    }

    // Function to apply the username color from the data attribute
    function applyUsernameColor() {
        const usernameElements = document.querySelectorAll('.user-profile-link.username-color');
        usernameElements.forEach(usernameElement => {
            const usernameColor = usernameElement.getAttribute('data-username-color');
            if (usernameColor) {
                usernameElement.style.color = usernameColor; // Set the username color
            }
        });
    }

    // Function to open the modal and display the larger image
function openModal(imageSrc) {
    const modal = document.getElementById("imageModal");
    const modalImage = document.getElementById("modalImage");

    modal.style.display = "block";
    modalImage.src = imageSrc;

    // Add an event listener to close the modal if the user clicks on the modal image
    modalImage.addEventListener('click', closeModal);

    // Add an event listener to close the modal if the user clicks outside of it
    document.addEventListener('click', closeModalOutside);
}


    // Function to close the modal
    function closeModal() {
        const modal = document.getElementById("imageModal");
        modal.style.display = "none";

        // Remove the event listener when the modal is closed
        document.removeEventListener('click', closeModalOutside);
    }

    // Function to close the modal if the user clicks outside of it
    function closeModalOutside(event) {
        const modal = document.getElementById("imageModal");
        if (event.target === modal) {
            closeModal();
        }
    }

    // Call these functions when the dashboard page loads
    window.addEventListener('load', () => {
        applyBorderColor();
        applyUsernameColor();
    });
</script>
</body>
</html>
