<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Profile</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='user_profile.css') }}">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
<div class="navbar">
    <span>Welcome, <a href="{{ url_for('profile') }}" class="username-link"><span class="username">{{ current_user.username }}</span></a>!</span>
    <button class="friends-button" onclick="window.location.href='{{ url_for('friends') }}'">Friends</button>
    <a href="{{ url_for('logout') }}" class="logout-button">Logout</a>
</div>
<!-- Add Reputation section -->
<div class="reputation-section">
    <h2 class="reputation-text">Reputation: <span id="reputation-count">{{ reputation }}</span></h2>
    <button id="give-reputation-button" data-receiver-user-id="{{ user.id }}">
        Give Reputation
    </button>
    <p id="reputation-message"></p>
    <div class="time-left-container">
    <span id="time-left" data-time-left="86400"></span>
        </div>
</div>
<div class="profile-container">
    <div class="profile-avatar">
        <!-- Display the user's avatar (profile photo) -->
        <img src="{{ url_for('static', filename='uploads/profile-photo/' ~ user.profile_photo) }}" alt="User Avatar">
    </div>
    <div class="profile-info">
        <!-- Display the user's name -->
        <h1 class="username-info">{{ user.username }}</h1>
        <div class="profile-header">
            <!-- Display follower and following counts -->
            <div class="follower-following-counts">
                <div class="follower-count">Followers: {{ user.followers|length }}</div>
                <div class="following-count">Follow: {{ user.following|length }}</div>
            </div>
            <!-- Follow/Unfollow button -->
            <div class="follow-unfollow-button">
            <button
                id="follow-btn"
                data-user-id="{{ user.id }}"
                {% if user in current_user.following %}
                    data-following="true"
                {% endif %}
            >
                {% if user in current_user.following %}
                    Unfollow
                {% else %}
                    Follow
                {% endif %}
            </button>
                </div>
        </div>
        <div class="center-button">
            <button class="back-button" onclick="window.location.href='{{ url_for('dashboard') }}'">Back</button>
        </div>
        <div class="dashboard-content">
    <div class="photo-section">
        <!-- ... -->
    </div>
<div class="uploaded-photos-section">
    <h2>Uploaded Photos</h2>
    <div class="uploaded-photos-grid">
        {% for uploaded_photo in user_uploaded_photos %}
            <div class="uploaded-photo-box">
                <div class="uploaded-photo">
                    <img src="{{ url_for('static', filename='uploads/' ~ uploaded_photo.filename) }}" alt="Uploaded Photo">
                </div>
            </div>
        {% endfor %}
    </div>
</div>

    </div>
</div>
</div>
<script>
    $(document).ready(function () {
        const followBtn = $('#follow-btn');
        const userId = followBtn.data('user-id');
        let isFollowing = followBtn.data('following');

        // Function to set the button text based on the initial state
        function setButtonText() {
            if (isFollowing) {
                followBtn.text('Unfollow');
            } else {
                followBtn.text('Follow');
            }
        }

        setButtonText(); // Set the initial button text

        followBtn.on('click', function () {
            if (isFollowing) {
                // User is currently following, so we should unfollow
                $.post(`/unfollow/${userId}`, function (data) {
                    isFollowing = false;
                    setButtonText();
                    console.log(data);
                });
            } else {
                // User is not following, so we should follow
                $.post(`/follow/${userId}`, function (data) {
                    isFollowing = true;
                    setButtonText();
                    console.log(data);
                });
            }
        });
    });

    document.addEventListener("DOMContentLoaded", function () {
        const reputationButton = document.getElementById("give-reputation-button");
        const reputationMessage = document.getElementById("reputation-message");
        const reputationCount = document.getElementById("reputation-count");
        const timeLeftSpan = document.getElementById("time-left");

        function updateTimer(timeLeftSeconds) {
            if (timeLeftSeconds <= 0) {
                timeLeftSpan.textContent = "You can give reputation now!";
            } else {
                const hours = Math.floor(timeLeftSeconds / 3600);
                const minutes = Math.floor((timeLeftSeconds % 3600) / 60);
                const seconds = timeLeftSeconds % 60;
                const formattedTimeLeft = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                timeLeftSpan.textContent = `You can only give reputation once every 24 hours (${formattedTimeLeft})`;
            }
            timeLeftSpan.style.color = "white";
        }

        const initialTimeLeft = parseInt(timeLeftSpan.getAttribute("data-initial-time-left"));
        if (!isNaN(initialTimeLeft)) {
            updateTimer(initialTimeLeft);
        }

        reputationButton.addEventListener("click", function () {
            fetch('/give-reputation', {
                method: 'POST',
                body: JSON.stringify({receiver_user_id: reputationButton.getAttribute('data-receiver-user-id')}),
                headers: {
                    'Content-Type': 'application/json',
                },
            })
                .then(response => {
                    if (response.ok) {
                        return response.json();
                    } else {
                        return Promise.reject('Error updating reputation');
                    }
                })
                .then(data => {
                    console.log(data);

                    if (data.error) {
                        reputationMessage.textContent = data.error;
                    } else if (data.updated_reputation !== undefined) {
                        reputationCount.textContent = data.updated_reputation;
                        reputationMessage.textContent = 'Reputation added successfully.';
                        reputationButton.disabled = true;
                    } else if (data.time_left_seconds !== undefined) {
                        const timeLeft = data.time_left_seconds;
                        updateTimer(timeLeft);
                    }

                    // Check if reputation can be given again
                    if (data.time_left_seconds === 0) {
                        reputationButton.disabled = false; // Enable the button
                    }

                    setTimeout(function () {
                        window.location.reload();
                    }, 1000);
                })
                .catch(error => {
                    reputationMessage.textContent = 'Error updating reputation';
                    console.error(error);
                });
        });
    });
</script>
</body>
</html>
